# 本地存储

本章节主要介绍如何在 Tauri v2 应用中实现数据的持久化存储。

### 暗黑模式持久化

对于前端简单的 UI 状态（如暗黑模式），推荐直接使用 `VueUse` 提供的工具，它底层基于浏览器的 `localStorage`。

只要在 `App.vue` 中调用一次 `useDark()`，它就会自动读取本地存储并应用主题。

**src/App.vue**:
```typescript
import { useDark } from '@vueuse/core';

// 初始化暗黑模式 (这就够了，它会自动生效并持久化)
useDark();
```

### 关于开机自启:

1. 系统级注册 ： tauri-plugin-autostart 插件的 enable() 和 disable() 方法是直接操作操作系统的 注册表 （在 Windows 上）或启动项配置。它不是保存在应用的临时内存里，而是写进了系统的启动列表里。
2. 状态读取机制 ：
   在代码的 onMounted 部分：
   
   ```typescript
   onMounted(async () => {
      try {
         // 这里是直接询问操作系统：“我这个软件在不在你的启动列表里？”
         autostartActive.value = await 
         isEnabled();
      } catch (error) {
         console.error('Failed to check 
         autostart status:', error);
      }
   });
   ```
   每次打开软件，组件加载时，都会通过 isEnabled() 再次向系统查询真实状态。因此，只要没有手动去系统设置里关掉它，软件里显示的开关状态就会和系统的实际状态保持一致。
总结 ：不需要写代码去保存这个开关的状态（比如存到 localStorage），Tauri 插件直接以操作系统的配置为准，状态是持久化的。


### 本地存储

本地存储 `tauri-plugin-store` 插件，它就像一个简单的文件数据库，把数据保存在用户的电脑上（通常是 JSON 文件）。

#### 1. 后端注册插件 (`lib.rs`)
首先要在 Rust 里启用这个插件：

```rust
pub fn run() {
    tauri::Builder::default()
        .plugin(tauri_plugin_store::Builder::default().build()) // 注册 Store 插件
        .run(tauri::generate_context!())
        .expect("error while running tauri application");
}
```

### 2.4 前端使用指南

Tauri v2 的 Store API 相比 v1 有了很大改进，支持强类型和自动保存。

#### 基础用法示例

```typescript
import { Store } from '@tauri-apps/plugin-store';

// 1. 加载（或创建）存储文件
// 'settings.json' 将会被保存在用户的应用数据目录下
const store = await Store.load('settings.json');

// 2. 写入数据
await store.set('user_name', 'Tauri User');
await store.set('app_config', { 
    theme: 'dark', 
    notifications: true 
});

// 3. 显式保存 (重要！v2 默认不会每次 set 都自动写入磁盘，除非配置了 autoSave)
await store.save();

// 4. 读取数据 (支持泛型)
const name = await store.get<string>('user_name');
const config = await store.get<{ theme: string }>('app_config');

console.log(name); // 输出: Tauri User
```

#### 高级用法：自动保存与默认值

你可以在加载 Store 时配置自动保存和默认值，这样就不需要手动调用 `.save()` 了。

```typescript
const store = await Store.load('app-data.json', {
  // 设置默认值：如果文件不存在或对应 key 不存在，将使用这些值
  defaults: {
    first_run: true,
    window_size: { width: 800, height: 600 }
  },
  // 开启自动保存：任何 set 操作后会在 100ms 后自动写入磁盘
  autoSave: 100 
});

// 因为开启了 autoSave，这行执行后会自动写入文件
await store.set('first_run', false); 
```

#### 实用 API

*   `store.has(key)`: 检查键是否存在
*   `store.delete(key)`: 删除某个键
*   `store.clear()`: 清空所有数据
*   `store.keys()`: 获取所有键名
*   `store.values()`: 获取所有值
*   `store.length()`: 获取数据条数

### 2.5 存储位置

在 Windows 上，数据通常保存在：
`C:\Users\用户名\AppData\Roaming\你的应用标识\settings.json`

这比 `localStorage` 更安全，且不容易被用户误清理。
