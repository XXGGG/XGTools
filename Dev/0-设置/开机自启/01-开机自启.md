# 开机自启 (Autostart)

## 1. 核心概念

Tauri 提供了官方插件 `tauri-plugin-autostart` 来管理应用的开机自启行为。它允许用户在前端控制是否启用自启。

**注意**:
- 开发环境 (`tauri dev`) 下，开机自启功能可能无法完全测试（因为它是针对打包后的应用的），但 API 调用可以模拟。
- 需要修改 Tauri 的权限配置 (`capabilities`) 才能在前端调用。

## 2. 安装插件

在项目根目录运行以下命令：

```bash
pnpm tauri add autostart
```

这个命令会自动：
1.  在 `src-tauri/Cargo.toml` 中添加 `tauri-plugin-autostart` 依赖。
2.  在 `src-tauri/src/lib.rs` 中初始化插件。

## 3. 配置权限 (Capabilities)

Tauri v2 默认禁止前端调用敏感 API。我们需要显式允许 `autostart` 的相关命令。

打开 `src-tauri/capabilities/default.json`，在 `permissions` 数组中添加以下内容：

```json
{
  "$schema": "../gen/schemas/desktop-schema.json",
  "identifier": "default",
  "description": "Capability for the main window",
  "windows": ["main"],
  "permissions": [
    "core:default",
    "opener:default",
    "autostart:allow-enable",
    "autostart:allow-disable",
    "autostart:allow-is-enabled"
  ]
}
```

> **注意**:
> 1. 这里的 `windows: ["main"]` 非常重要，它指定了这些权限赋予给哪个窗口。
> 2. 请确保 `tauri.conf.json` 中的 `windows` 配置里，主窗口的 `label` 属性设置为 `"main"`。

## 4. 前端实现 (Vue 组件)

创建一个新的设置组件 `src/components/Settings/AutostartToggle.vue`。

### 代码示例

运行：`pnpm dlx shadcn-vue@latest add switch`

```vue
<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { enable, disable, isEnabled } from '@tauri-apps/plugin-autostart';
import { Switch } from '@/components/ui/switch';

const autostartActive = ref(false);

// 初始化时检查当前状态
onMounted(async () => {
   try {
      autostartActive.value = await isEnabled();
   } catch (error) {
      console.error('Failed to check autostart status:', error);
   }
});

// 切换处理函数
const toggleAutostart = async (checked: boolean) => {
   try {
      if (checked) {
         await enable();
         console.log('Autostart enabled');
      } else {
         await disable();
         console.log('Autostart disabled');
      }
      autostartActive.value = checked;
   } catch (error) {
      console.error('Failed to toggle autostart:', error);
      // 失败时回滚状态
      autostartActive.value = !checked;
   }
};
</script>

<template>
      <Switch id="autostart-mode" :model-value="autostartActive" @update:model-value="toggleAutostart" />
</template>
```

> **关于 shadcn-vue (reka-ui) Switch 组件的坑**:
> 新版 shadcn-vue 底层使用 `reka-ui`，其 Switch 组件的 API 使用 `:model-value` 和 `@update:model-value`，而不是传统的 `:checked`。如果使用 `:checked`，点击时可能没有反应。